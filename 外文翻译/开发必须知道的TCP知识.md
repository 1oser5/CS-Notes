# 开发必须知道的TCP知识

> 原文链接 https://robertovitillo.com/what-every-developer-should-know-about-tcp/

## 前言

为什么你应该在地理上尽可能的将服务器靠近用户？低延迟是其中一个理由。当你发送大量数并且应当被尽快交付时，这很有意义。但是对于大文件来说呢，比如视频文件。当然在接受第一个字节的时候会有延迟损失，但是之后应该很流畅么？

在我们使用 TCP 传输数据时，比如 HTTP，会有常识性错误，认为带宽取决于延迟。事实上，TCP的带宽是延迟和时间的某个函数。


## 握手

在客户端可以向服务器发送数据之前，需要为 TCP 和 TLS 各进行一次握手。

TCP 使用三次握手来创建新连接。

### TCP三次握手

1.发送方选择一个随机生成的序列号 `x` 同时发生 `SYN` 包给接收方。
2.接收方将 `x` 加1，也选择一个随机生成的序列号 `y` 同时发生一个 `SYN/ACK` 包。
3.接收方将俩个序列号都加一并且用 `ACK` 包和应用程序的第一个字节进行回复。

TCP 使用序列号来确认数据是否被按序交付。

![avator](../../pic/外文翻译-u-most-know-tcp-tcp-threeshake.png)

握手中的往返时间取决于网络延迟。TLS 握手同意需要两次往返。在 TSL 连接建立之前，应用数据内容将不会被发送。这意味着在建立连接之前为零。往返时间越短，建立连接的数据越快。

## 流量控制

流量控制是一种防止发送方使得接收方不堪重负的保护机制。

接收方将等待应用程序处理的传入 TCP 数据包存储到接收缓存区中。

![avator](../../pic/外文翻译-u-most-know-tcp-接收缓存.png)

同时接收方也会在接受到一个包后恢复给发送方缓存大小。发送方遵守协议，避免发送超过接收方缓存的数据。

![avator](../../pic/外网翻译-tcp-发送buffer.png)

该机制和应用层的限速不一样，比在 API 或者 IP 地址显示更好，因为 TCP 限速是在传输层。

发送方和接收方的往返时间越低，则发送方能更快地将带宽调整为接收方的容量。

## 拥塞控制

TCP 不仅防范接收方过载，同时还考虑了网络拥堵情况。

发送方如何知道当前网络的可接受带宽呢？估计它的唯一方法是根据经验进行测量。

这个想法是发送方维护一个叫做 `拥塞窗口` 的字段。这个窗口表示不需要等待接收方确认的未处理标准包总数。接收窗口的大小限制了拥塞窗口的最大值。拥塞窗口越小，在任何给定时间内可传输的字节越少，占用带宽更少。

当一个新连接建立时，拥塞窗口大小为系统默认大小。每一个包被确认后，拥塞窗口大小会指数的增加。这意味着我们在连接建立还不能使用全部的网络带宽。又一次，越小的往返时间，使得接收方能更快地利用网络带宽。

![avator](../../pic/外文翻译-tcp-拥塞窗口.png)

## 拥塞避免

如果包丢失时会发生什么呢？当发送方通过超时检测检测到未确定的包后，`拥塞避免` 机制启动，拥塞窗口的大小会减小。从这时开始，拥塞窗口大小线性增加，超时会使窗口大小另外减少。

正如之前提到的，拥塞窗口大小定义了不需要接收方等待确认的最大字节数量。发送方需要等待一次往返时间来接受确认。所以通过拥塞窗口除以往返时间，我们得到了理论带宽的最大值。

![avator](../../pic/外文翻译-tcp-理论带宽.jpg)

这个简单的等式证明了带宽是和延迟有关的函数。TCP 会非常努力的调整大小，但是它对往返时间却无能为力。这通常不是最佳配置。

总结一下，拥塞控制是一种用来推断基础带宽和网络拥塞的适应性机制。应用层也提供了相似的模式。想想当你在网飞上看电影时，它开始时模糊的，之后，他会稳定到合理水平，直到网络情况再次变差为之。这种视频流传输机制被称为 `自适应比特率流`。

如果你使用了 HTTP，那么你最好了解对应的协议，如果你不知道配方，那么你就不能做到最好。