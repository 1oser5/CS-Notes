# 网络层

网络层是互联网的核心，使用 IP 协议可以把本来异构的物理网络连接起来，使得网络层好像是在一个统一的网络

与 IP 协议配合的还有三个协议：
+ 地址解析协议 ARP
+ 网络控制报文协议 ICMP
+ 网络组管理协议 IGMP

## IP数据报格式

![avator](../../pic/wlc-ip-data-format.jpeg)

+ 版本：ipv4 和 ipv 6
+ 首部长度：占4位，最大为 15，1表示4字节，由于 IP 数据包首部固定长度为 20 字节，因此最小值为 5
+ 总长度：首部长度 + 数据部分长度
+ 生存时间：TTL，为了防止无法交付的数据在互联网中一直兜圈子，即防止路由循环，以 **路由器条数** 为单位，当 TTL 为 0 时丢弃数据包
+ 协议：指出数据该有哪个协议处理
+ 首部检验和：每次跳转路由器之后需要重新计算检验和，因此检验和不包括数据部分可以减少计算量
+ 标识：在数据过程而分片之后，标识同一数据包的字段
+ 标志：占3位。第二位 DF 表示是否允许分片，取 1 时表示不允许分片，第三位为 MF，表示是否还有更多分片，0 时表示没有分片。
+ 片偏移：用于发生分片情况，片偏移量为 8 字节

![avator](../../pic/计算机网络-ip数据包-片偏移.png)


## IP 分片

### 为什么分片

虽然一个 IP 报文最多可以达到 65565 的最大长度，但是网络硬件 最大传输单元（MTU）限制了帧的大小（以太网限制为 1500 字节），所以会进行分片。


## IP 地址编址

### 分类

ip 地址 ::= {<网络号>, <主机号>}

一共有三类，不同的地址有这不同的网络号，并且是固定的

![avator](../../pic/计算机网络-网络层-ip地址分类.png)


### 子网划分

将主机号的一部分作为子网号，把两级 IP 地址划分三级

ip 地址 ::= {<网络号>, <子网号>, <主机号>}

要使用子网，必须配置子网掩码。一共 B 类的子网掩码默认为 255.255.0.0

#### 子网掩码计算

##### 子网数

1.将子网数转为二进制

2.获得其长度记为 N

3.获得该类地址默认子网掩码，将 **主机部分前 N 位** 置为 1，即得到该地址划分出子网的子网掩码

Example

将B类IP地址168.195.0.0划分成27个子网

1. 27=11011
2. N = 5
3. 默认子网掩码为 255.255.0.0，修改为二进制，再将其主机部分前 N 位置为 1，得到 11111111.11111111.11111000.00000000，即为 255.255.248.0

##### 主机数

1.将主机数转为二进制表示
2.将其长度即为 N
3.将对应类子网掩码主机位全部置为 1，或者理解成子网掩码默认为 255.255.255.255
4.从后往前将 N 位 1 置为 0

Example

B类IP地址168.195.0.0划分成若干子网，每个子网内有主机700台，主机数应该+2吧？
1. 700 = 1010111100
2. N = 10
3. 将 255.255.255.255 的二级制表示从后向前 N 位 置为 0，即 11111111.11111111.11111100.00000000，即 255.255.252.0

### 无分类
取消了传统的 A、B、C 三类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀是可变的

ip 地址 ::= {<网络前缀号>, <主机号>}

## 地址解析协议 ARP

网络层实现主机之间的通信，而链路层实现每段链路间的通信，在通信过程中，IP 数据报的源地址和目标地址始终不变，而 MAC 地址跟随链路而改变

ARP 实现由 IP 地址得到 MAC 地址

每个主机都有 ARP 高速缓存，在里面存储了局域网上的各主机及路由器的 IP 到 MAC 地址的映射表

如果 A 主机知道 B 的 IP 地址，但本机的 ARP 高速缓存中没有该 IP 地址到 MAC 地址的映射，此时 A 将通过广播发送 ARP 请求分组，B 接收到该请求后悔发送 ARP 响应分组告知 A 其 MAC 地址，然后 A 在其 ARP 高速缓存中写入 B 的 IP 地址到 MAC 地址的映

在发送 ARP 请求是，会将目标 MAC 地址写为 FF:FF:FF:FF:FF:fF

![avator](../../pic/计算机网络-网络层-arp协议.png)

## 网络控制报文协议 ICMP

ICMP协议是一种面向无连接的协议，用于传输错误报告信息，从技术层面讲，ICMP 就是一种 "错误侦测与回报机制"，更够更有效地转发 IP 数据和提高交付成功的机会。

ICMP 报文分为 差错报告报文 和 询问报文

![avator](../../pic/计算机网络-网络层-icmp.png)

### Ping

Ping 是 ICMP 的一个重要应用，用来测试两台机器的连通性

Ping 原理是向目标机器发送 ICMP Echo 请求报文，目标机器收到后会发送 Echo 回答报文。Ping 会根据时间和相应次数估算出数据包往返时间和丢包率


### Traceroute

Traceroute 是 ICMP 的另一个应用，用来追踪一个分组从原点到终点的路径

Traceroute 发送的 IP 数据报是一个无法交付的 UDP 数据报，并由目标主机发送终点不可达差错报告

+ 源主机会向目标主机发送一连串的 IP 数据报，第一个数据报 P1 的生存时间为 1，当 P1 达到路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL = 0，R1 就会把 P1 丢弃，然后向源主机发送 ICMP 时间超过差错报告报文
+ 源主机发送第二个数据报，其生存时间为 2，经过第一个路由器 R1 时会被减 1，在转发给 R2， R2 收下后再将 TTL - 1，这是 TTL = 0，R2 就会丢弃 P2，向源主机发送 ICMP 时间超过差错报告报文
+ 不断执行上述步骤，最后达到目标主机，主机不转发数据报，也不将 TTL 值减 1.因为数据报内是无法交付的 UDP，因为目标主机会向源主机发送 ICMP 终点不可达差错报告报文
+ 源主机就知道了达到目标主机的所路径的 IP 路由器以及每个路由器的往返时间

## 虚拟专用网 VPN

由于 IP 地址紧缺，一个机构能申请到的 IP 一定小于 本机构拥有的主机数，并且一个机构并不需要把所有主机接入到外部互联网。

内网专用地址块：

+ 10.0.0.0 ~ 12.255.255.255
+ 172.16.0.0 ~ 172.31.255.255
+ 192.186.0.0 ~ 192.168.255.255


如果场所 A 的主机 X 要和另一个场所 B 的主机 Y 通信，会经过以下步骤
+ 主机 X 将数据包发送到与互联网相连的 R1，数据包的原地址为 10.1.0.1，目标地址为 10.2.0.3
+ R1 将对内部数据加密，然后重新加上数据包的首部，源地址为 R1 的全球地址 125.1.2.3，目标地址为路由器 R2 的全球地区 194.4.5.6
+ R2 收到数据包后将数据部分进行解密，恢复原来的数据包，此时目标地址为 10.2.0.3，交付给 Y

![avator](../../pic/计算机网络-网络层-vpn.jpeg)

## 网络地址转化 NAT

专用网内部的主机使用本地 IP 地址又想和互联网的主机通信时，可以使用 NAT 来将本地 IP 转化为全球 IP。

一起 NAT 将本地 IP 和 全球 IP 一样对应,这样的话拥有 N 个全球 IP 的专用网只能同时有 N 台主机接入互联网

现在常用的 NAT 转换表将端口号也用上了，使得多个内部主机可以共用一个全球 IP 地址

## 路由器结构

路由器从功能上可以分为：路由选择和分组转发

分组转发分为三个部分：交换结构、一组输入端口、一组输出端口

![avator](../../pic/计算机网络-网络层-路由器结构.jpeg)

### 路由器分组转发流程

+ 从数据报首部分理处 IP 地址 D，得到目标网络地址 N
+ 如果 N 是与此路由器直接相连的某个网络地址，直接交付
+ 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给表中所指明的下一跳路由器
+ 若路由表中有达到网络 N 的路由,则把数据报传送给表中所指明的下一跳路由器
+ 如果路由表中有一个默认路由,则把数据包传输给路由表中所指明的默认路由器
+ 报告转发分组出错

![avator](../../pic/计算机网络-网络层-路由分组转发.jpeg)

### 路由选择协议

路由选择协议分为俩大类：
+ 自治系统内部路由选择：RIP 和 OSPF
+ 自治系统间的路由选择：BGP