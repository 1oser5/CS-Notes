# 传输层
传输层提供了进程间的通信

## UDP和TCP的区别

### UDP
+ 无连接
+ 不可靠（尽最大努力交付）
+ 面向报文
+ 无拥塞机制
+ 支持一对一，多对多，多对一通信

### TCP
+ 面向连接
+ 可靠交付
+ 面向字节流
+ 有拥塞机制
+ 双全工通道
+ 每条TCP支持一对一

### UDP首部

![avator](../pic/计算机网络-传输层-udp.jpeg)

UDP首部只有8字节，12字节的伪首部是为了计算检验和临时添加的

### TCP首部

![avator](../pic/计算机网络-传输层-tcp.png)

+ 序号：对字节流进行编号，如果当前序号为301，如果数据长度为200，则下一个报文段的编号为 501
+ 确认号，如果 A->B 时报文段为 301，数据长度为200，则确认号为 501
+ 数据偏移：首部长度
+ 确认ACK：当AKC=0时确认字段有效，否则报文段无效。TCP规定建立连接后所有报文段ACK都置为1
+ 同步SYN：连接使用来同步序号，如果ACK=1,SYN=0表示是请求连接报文段，若双方同意连接，则ACK=1,SYN=1
+ 终止FIN：表示此报文段发送方已经发送完数据，请求释放连接

### TCP三次握手

![avator](../pic/计算机网络-传输层-tcp-三挥.png)

#### 第一次握手

CLIENT 将 ACK 置为1，随机产生一个初始序列发给 SERVER，进入 SYN_SENT 状态

#### 第二次握手

SERVER 收到 CLIENT 的 ACK=1，知道 CLIENT 请求连接，这时候会把SYN置1，ACK置1，产生一个随机序列，产生一个确认号为 CLIENT序列号+1，发给CLIENT，进入 SYN_RVCD 状态

#### 第三次握手

CLIENT 检查确认号是否为序列号+1，将ACK置1，产生一个确认号等于服务器初始序号+1，发送给服务器，进入ESTABLISHED状态，SERVER检查确认号正确和ACK=1后，也进入ESTABLISHED状态，连接建立

### TCP 三握问题

#### 为什么要第三次握手

+ 无法确认CLIENT是否收到了报文段
+ 已失效的报文段因为网络滞留延迟到达服务器，则server就会打开连接，浪费了资源

#### 第三次客户端ACK未送达，会怎么样

如果SERVER未收到ACK确认报文，则会重发 ACK+SYN，默认重发5次，之后自动关闭连接进入CLOSED状态

CLIENT如果在超时重传时再次发送数据，则SERVER确认之后建立连接，进入ESTABLISHED状态。
如果SERVER已关闭，则会以RST包应答


#### 建立连接但是客户端出现了故障

SERVER每次收到请求后就会复位一个计时器，一般是2小时，如果规定时间内CLINET没有发生数据，则SERVER会发生一个探测报文段，每隔75s发送一次，如果十次之后都没有反应，则SERVER默认CLIENT故障，关闭连接。


### TCP四次挥手
![avator](../pic/计算机网络-传输层-tcp-四挥.jpeg)

#### 第一次挥手

CLIENT 将FIN置为 1，发送一个序列号给SERVER,进入FIN_WAIT_1昨天

#### 第二次挥手
SERVER收到报文，将ACK置为1（本来也为1吧），确认号为序列号+1，进入CLOSE_WAIT状态，此CLIENT无法向SERVER发送数据，而SERVER还能发送数据

#### 第三次挥手
SERVER将FIN置为1，发送一个初始化队列，进入LAST_ACK状态

#### 第四次挥手
CLIENT将确认号设置为序列号+1，发送报文段，CLIENT进入TIME_WAIT状态，SERVER收到后进入CLOSED状态，CLIENT在2*MSL之后如果未收到SEVER报文，也进入CLOSED


### TCP 四挥问题

#### 第二次和第三次挥手能否合并

在SERVER收到CLIENT断开连接请求之后，可能还有部分数据没有发送完，这时候应该先确认收到了断开连接请求，在等数据发送完毕之后，再发FIN，因此不能合并。

#### 第二次挥手CLIENT未收到SERVER发送的ACK

CLIENT会重发FIN请求

#### CLIENT TIME_WAIT的意义

第四次挥手时，CLIENT发送给SERVER的ACK确认可能会丢失，这时候SERVER会重发FIN请求，TIME_WAIT就是用来避免这种情况，接收SERVER重发请求的。如果CLIENT在2*MSL之内为收到FIN请求，默认SERVER已收到，关闭连接。
MSL(Maximum Segment Lifetime)，指一个片段在网络中最大的存活时间，2MSL就是一个发送和一个回复所需的最大时间。
