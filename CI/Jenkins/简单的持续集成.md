# 简单的持续集成和持续部署

今天在学习有关自动化测试相关的知识的时候，看到知乎有人说起有关持续化集成和持续部署的简单结构，看上去简单清晰，十分好用。希望能在6月成功在公司部署上线。

首先需要厘清一下几个概念：

+ 什么是CI/CD？
+ CI/CD的优劣
+ 什么是自动化测试
+ 自动化对CI/CD的意义

## 什么是CI/CD

### CI

CI 的全称是 Continuous Integration，表示持续集成。
在 CI 环境中，开发人员会频频向主干提交代码，这些代码在真正合并到主干前，会使用 **自动化测试** 来进行验证。

自动化测试的结果决定了本次提交是否能合并到主干。

#### 需要的条件

1.一台 CI 服务器
2.为不同功能设计的自动化测试（应是持续不断修改的）
3.开发需要模块化提交代码，提高频率（一下提交过多代码会导致自动化测试无法正常回归，同时越多的代码错误的概率也会上升）

#### 优点

1.在初期构建好环境后，只需要不断维护测试脚本即可，测试成本大幅下降
2.CI 服务器可以同时运行上百条测试语句，成倍提高测试效率
3.保证了主干代码的可用性，减少了交付压力
4.帮助测试排除了一些低级错误

### CD

CD 的全称为 Continuous Deployment，表示持续部署。

在持续部署环境中，通过自动化构建、测试、部署来快速完成高质量产品的交付。传统的 `交付日` 概念消失了。取而代之的时更小颗粒度并且不丢失健壮性的发布。

当一个提交被主干接受时，会自动触发脚本，来对发布流程进行一系列的测试。如果全部编译通过，则会将其直接部署到生产环境中。

#### 需要的条件

1.严格管控的代码质量
2.和版本一致的文档
3.发布权限级别（你可不想在用户面前出丑）

#### 优点

1.版本迭代快，客户可以看到变化
2.小批量发布对错误的定位有所帮助
3.没有交付日就没有加班

### 什么是自动化测试

自动化测试是指通过测试脚本的编写，来实现人工测试无法实现，或者疲于实现的一些测试目标。比如常见的压力测试，或者大规模的回归测试。有了自动化测试。可以缓解测试的部分压力。让测试更注重于某些高级部分，而不是持续化的回归。同时自动化测试也防止人工测试的一些疏漏，相较来说更加忠诚全面。其没有人工思维的惯性，可以给测试很好的帮助。

自动化测试总的来说分为两种，GUI测试和接口测试

#### GUI测试

主要是目的是模拟用户行为，比如用户的点击行为和键盘输入行为。通过黑盒方式来找出程序中的一些问题。

#### 接口测试


通过直接调取后端接口的方式进测试，判断接口的数据返回格式，数据内容等来判断接口是否表现正常。

#### 测试效率

从一般角度来说，接口测试比GUI测试有着更高的覆盖性和保障性。GUI测试一般在回归测试中使用，并且难以抽象，因为页面的逻辑大不相同。

有一幅测试中常见的图，可以看到其中的差别

![avator](https://raw.githubusercontent.com/1oser5/CS-Notes/master/pic/CICD-测试成本.jpg)

从下到上，测试成本越来越高，而效率却越来越低。这和测试的本质有关，因为越往下，越模块化。代码越少，甚至多人协作的差错也越少。因此最具有稳定性和性价比。而最上层的UI测试，或者说GUI测试。是多人合作的结果，并且处于黑盒状态。很难一下子找出所有问题。

### 自动化对CI/CD的意义

自动化赋予了CI/CD真正的活力。完成度很高的一套CI/CD框架，应该具极强的健壮性，基本上能够处理或者包括一切情况，在这种情况下，通常测试只需要查看CI/CD日志，或者直接点击确认发布按钮。就能快速完成对一个版本的回归。在自动化的帮助下，CI/CD真正做到了快速而且高效。


## 简单的框架

这套框架是看知乎看来的，就多引入了一个软件Jenkins。关于Jenkins就不再赘述了。

框架的图贴在这里

![avator](https://raw.githubusercontent.com/1oser5/CS-Notes/master/pic/CI:CD-简单框架.jpg)

### CI

CI 部分使用 Git Hook 对提交的代码自动运行测试，如果测试不通过则本次提交将不会提供。

在开发提交后，钩子会自动调用脚本对本次提交进行测试。如果成功则能提交到远程dev分支

这种CI的手段成本极低，只需要维护脚本即可。因为钩子什么的Git已经帮你弄好了，并且有成熟的接口。可以直接使用。


### CD

在代码通过测试成功来到远程dev分支时，Jenkins出场了，Jenkins可以监听对应分支的线上代码变化，如果有变化就可以自动执行服务，首选其在其本地或者Slave的WorkSpace将最新修改拉取，并将修改合并到本地master分支，再次执行测试，如果测试通过，则上传到远程master分支，或者直接进行部署。

### 总结

这套框架十分简单，只用到了Jenkins和Git相互配合，就实现了一套比较完整的持续集成和持续部署流程。